---
title: "FFT-Sorting: Dimensionality Reduction of Motion Features with Linear Optimal Low Rank Projection (LOL)"
author: "Shubhayu Bhattacharyay and Matthew Wang"
date: "4/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(devtools)
if (!require(lolR)) install_github('neurodata/lol', build_vignettes=TRUE, force=TRUE)
library(lolR)
library(R.matlab)
library(tidyverse)
library(ggplot2)
library(plotly)
library(naniar)
library(MASS)
if(!exists("sensors")) {
  sensors<-readMat('../motion_feature_data/bed_corrected_imputed_complete_sensor_data.mat')$bed.corrected.sensors
}
na_strings <- c("NA", "N A", "N / A", "N/A", "N/ A", "Not Available", "NOt available","NaN")
if(!exists("patient_table")) {
  patient_table<-read.csv('../clinical_data/patient_table.csv',na.strings=c("NA","NaN", " ") )%>%replace_with_na_all(condition = ~.x %in% na_strings)%>%mutate(GOSE=factor(GOSE),GOSE_1yr=factor(GOSE_1yr),Death=factor(Death),Death_1yr=factor(Death_1yr))
}
studyPatients<-c(2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,58,59,60,61,62,63,64,66,67)
studyPatientsPY<-c(2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,49,51,46,47,48,50,52,53,54,55,56,57,59,60,61,62,63,64,65,67,68)
```

## Key Links:
[GOSE](#viz_GOSE)

[GOSE 1 Year](#viz_GOSE_1yr)

[Death](#viz_Death)

[Death 1 Year](#viz_Death_1yr)

## Resolve mismatch between accelerometry and clinical data

```{r}
sortOrder<-sort(studyPatientsPY,index.return=TRUE)$ix
PYpatient_table<-patient_table[sortOrder,]
PY_1yr_patient_table<-PYpatient_table %>% drop_na(Death_1yr)
```

## Organize `sensors` data

Please note that the following chunk takes about 4.5 minutes to run

```{r}
start_time <- Sys.time()
temp_var<-do.call(rbind,sensors)
temp_var<-lapply(temp_var, function(x) abs(t(mvfft(t(x)))))
band_powerFeats<-do.call(cbind,temp_var[1:6])
freq_entropyFeats<-do.call(cbind,temp_var[7:12])
freq_pairsFeats<-do.call(cbind,temp_var[13:24])
med_freqFeats<-do.call(cbind,temp_var[25:30])
smaFeats<-do.call(cbind,temp_var[31:36])
waveletsFeats<-do.call(cbind,temp_var[37:42])
end_time <- Sys.time()
end_time - start_time
```

## Run Linear Optimal Low Rank Projection

```{r}
# GOSE at Discharge
r<-5
Y<-PYpatient_table$GOSE
band_powerLOL_GOSE <- lol.project.lol(band_powerFeats, Y, r)
freq_entropyLOL_GOSE <- lol.project.lol(freq_entropyFeats, Y, r)
freq_pairsLOL_GOSE <- lol.project.lol(freq_pairsFeats, Y, r)
med_freqLOL_GOSE <- lol.project.lol(med_freqFeats, Y, r)
smaLOL_GOSE <- lol.project.lol(smaFeats, Y, r)
waveletsLOL_GOSE <- lol.project.lol(waveletsFeats, Y, r)

# GOSE 1 Year after Discharge
r<-5
Y<-PYpatient_table$GOSE_1yr
band_powerLOL_GOSE_1yr <- lol.project.lol(band_powerFeats[!is.na(Y),], Y[!is.na(Y)], r)
freq_entropyLOL_GOSE_1yr <- lol.project.lol(freq_entropyFeats[!is.na(Y),], Y[!is.na(Y)], r)
freq_pairsLOL_GOSE_1yr <- lol.project.lol(freq_pairsFeats[!is.na(Y),], Y[!is.na(Y)], r)
med_freqLOL_GOSE_1yr <- lol.project.lol(med_freqFeats[!is.na(Y),], Y[!is.na(Y)], r)
smaLOL_GOSE_1yr <- lol.project.lol(smaFeats[!is.na(Y),], Y[!is.na(Y)], r)
waveletsLOL_GOSE_1yr <- lol.project.lol(waveletsFeats[!is.na(Y),], Y[!is.na(Y)], r)

# Mortality at Discharge
r<-5
Y<-PYpatient_table$Death
band_powerLOL_Death <- lol.project.lol(band_powerFeats, Y, r)
freq_entropyLOL_Death <- lol.project.lol(freq_entropyFeats, Y, r)
freq_pairsLOL_Death <- lol.project.lol(freq_pairsFeats, Y, r)
med_freqLOL_Death <- lol.project.lol(med_freqFeats, Y, r)
smaLOL_Death <- lol.project.lol(smaFeats, Y, r)
waveletsLOL_Death <- lol.project.lol(waveletsFeats, Y, r)


# Mortality within 1 Year after Discharge
r<-5
Y<-PYpatient_table$Death_1yr
band_powerLOL_Death_1yr <- lol.project.lol(band_powerFeats[!is.na(Y),], Y[!is.na(Y)], r)
freq_entropyLOL_Death_1yr <- lol.project.lol(freq_entropyFeats[!is.na(Y),], Y[!is.na(Y)], r)
freq_pairsLOL_Death_1yr <- lol.project.lol(freq_pairsFeats[!is.na(Y),], Y[!is.na(Y)], r)
med_freqLOL_Death_1yr <- lol.project.lol(med_freqFeats[!is.na(Y),], Y[!is.na(Y)], r)
smaLOL_Death_1yr <- lol.project.lol(smaFeats[!is.na(Y),], Y[!is.na(Y)], r)
waveletsLOL_Death_1yr <- lol.project.lol(waveletsFeats[!is.na(Y),], Y[!is.na(Y)], r)


# band_powerLOL_GOSE <- lol.xval.eval(band_powerFeats, Y, r, alg = lol.project.lol, alg.return="A", classifier=MASS::lda, classifier.return="class", k=5)
```

## Visualize GOSE at Discharge LOL projections {#viz_GOSE}

```{r echo=FALSE}

## GOSE at Discharge

# band_power

data <- data.frame(x1=band_powerLOL_GOSE$Xr[,1], x2=band_powerLOL_GOSE$Xr[,2],x3=band_powerLOL_GOSE$Xr[,3],y=PYpatient_table$GOSE)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Band Power GOSE") +
  labs(color = "GOSE_dis")
ggplotly(viz)

# freq_entropy

data <- data.frame(x1=freq_entropyLOL_GOSE$Xr[,1], x2=freq_entropyLOL_GOSE$Xr[,2],x3=freq_entropyLOL_GOSE$Xr[,3],y=PYpatient_table$GOSE)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Entropy GOSE") +
  labs(color = "GOSE_dis")
ggplotly(viz)

# freq_pairs

data <- data.frame(x1=freq_pairsLOL_GOSE$Xr[,1], x2=freq_pairsLOL_GOSE$Xr[,2],x3=freq_pairsLOL_GOSE$Xr[,3],y=PYpatient_table$GOSE)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Pairs GOSE") +
  labs(color = "GOSE_dis")
ggplotly(viz)

# med_freq

data <- data.frame(x1=med_freqLOL_GOSE$Xr[,1], x2=med_freqLOL_GOSE$Xr[,2],x3=med_freqLOL_GOSE$Xr[,3],y=PYpatient_table$GOSE)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Med Freq GOSE") +
  labs(color = "GOSE_dis")
ggplotly(viz)

# sma

data <- data.frame(x1=smaLOL_GOSE$Xr[,1], x2=smaLOL_GOSE$Xr[,2],x3=smaLOL_GOSE$Xr[,3],y=PYpatient_table$GOSE)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("SMA GOSE") +
  labs(color = "GOSE_dis")
ggplotly(viz)

# wavelets

data <- data.frame(x1=waveletsLOL_GOSE$Xr[,1], x2=waveletsLOL_GOSE$Xr[,2],x3=waveletsLOL_GOSE$Xr[,3],y=PYpatient_table$GOSE)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Wavelets GOSE") +
  labs(color = "GOSE_dis")
ggplotly(viz)
```


## Visualize GOSE 1 Year after discharge LOL projections {#viz_GOSE_1yr}

```{r echo=FALSE}
## GOSE 1 Year after Discharge
# band_power

Y<-PYpatient_table$GOSE_1yr
Y<-Y[!is.na(Y)]

data <- data.frame(x1=band_powerLOL_GOSE_1yr$Xr[,1], x2=band_powerLOL_GOSE_1yr$Xr[,2],x3=band_powerLOL_GOSE_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Band Power GOSE at 1 year") +
  labs(color = "GOSE_yr")
ggplotly(viz)

# freq_entropy

data <- data.frame(x1=freq_entropyLOL_GOSE_1yr$Xr[,1], x2=freq_entropyLOL_GOSE_1yr$Xr[,2],x3=freq_entropyLOL_GOSE_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Entropy GOSE at 1 year") +
  labs(color = "GOSE_yr")
ggplotly(viz)

# freq_pairs

data <- data.frame(x1=freq_pairsLOL_GOSE_1yr$Xr[,1], x2=freq_pairsLOL_GOSE_1yr$Xr[,2],x3=freq_pairsLOL_GOSE_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Pairs GOSE at 1 year") +
  labs(color = "GOSE_yr")
ggplotly(viz)

# med_freq

data <- data.frame(x1=med_freqLOL_GOSE_1yr$Xr[,1], x2=med_freqLOL_GOSE_1yr$Xr[,2],x3=med_freqLOL_GOSE_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Med Freq GOSE at 1 year") +
  labs(color = "GOSE_yr")
ggplotly(viz)

# sma

data <- data.frame(x1=smaLOL_GOSE_1yr$Xr[,1], x2=smaLOL_GOSE_1yr$Xr[,2],x3=smaLOL_GOSE_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("SMA GOSE at 1 year") +
  labs(color = "GOSE_yr")
ggplotly(viz)

# wavelets

data <- data.frame(x1=waveletsLOL_GOSE_1yr$Xr[,1], x2=waveletsLOL_GOSE_1yr$Xr[,2],x3=waveletsLOL_GOSE_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Wavelets GOSE at 1 year") +
  labs(color = "GOSE_yr")
ggplotly(viz)
```

## Visualize Mortality at discharge LOL projections {#viz_Death}

```{r echo=FALSE}
## Mortality at Discharge
# band_power

Y<-PYpatient_table$Death
Y<-Y[!is.na(Y)]

data <- data.frame(x1=band_powerLOL_Death$Xr[,1], x2=band_powerLOL_Death$Xr[,2],x3=band_powerLOL_Death$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Band Power Mortality at Discharge") +
  labs(color = "Death_dis")
ggplotly(viz)

# freq_entropy

data <- data.frame(x1=freq_entropyLOL_Death$Xr[,1], x2=freq_entropyLOL_Death$Xr[,2],x3=freq_entropyLOL_Death$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Entropy Mortality at Discharge") +
  labs(color = "Death_dis")
ggplotly(viz)

# freq_pairs

data <- data.frame(x1=freq_pairsLOL_Death$Xr[,1], x2=freq_pairsLOL_Death$Xr[,2],x3=freq_pairsLOL_Death$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Pairs Mortality at Discharge") +
  labs(color = "Death_dis")
ggplotly(viz)

# med_freq

data <- data.frame(x1=med_freqLOL_Death$Xr[,1], x2=med_freqLOL_Death$Xr[,2],x3=med_freqLOL_Death$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Med Freq Mortality at Discharge") +
  labs(color = "Death_dis")
ggplotly(viz)

# sma

data <- data.frame(x1=smaLOL_Death$Xr[,1], x2=smaLOL_Death$Xr[,2],x3=smaLOL_Death$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("SMA Mortality at Discharge") +
  labs(color = "Death_dis")
ggplotly(viz)

# wavelets

data <- data.frame(x1=waveletsLOL_Death$Xr[,1], x2=waveletsLOL_Death$Xr[,2],x3=waveletsLOL_Death$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Wavelets Mortality at Discharge") +
  labs(color = "Death_dis")
ggplotly(viz)
```

## Visualize Mortality within 1 year of discharge LOL projections {#viz_Death_1yr}

```{r echo=FALSE}
## Mortality within 1 Year of Discharge
# band_power

Y<-PYpatient_table$Death_1yr
Y<-Y[!is.na(Y)]

data <- data.frame(x1=band_powerLOL_Death_1yr$Xr[,1], x2=band_powerLOL_Death_1yr$Xr[,2],x3=band_powerLOL_Death_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Band Power Mortality within 1 Year") +
  labs(color = "Death_yr")
ggplotly(viz)

# freq_entropy

data <- data.frame(x1=freq_entropyLOL_Death_1yr$Xr[,1], x2=freq_entropyLOL_Death_1yr$Xr[,2],x3=freq_entropyLOL_Death_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Entropy Mortality within 1 Year") +
  labs(color = "Death_yr")
ggplotly(viz)

# freq_pairs

data <- data.frame(x1=freq_pairsLOL_Death_1yr$Xr[,1], x2=freq_pairsLOL_Death_1yr$Xr[,2],x3=freq_pairsLOL_Death_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Freq Pairs Mortality within 1 Year") +
  labs(color = "Death_yr")
ggplotly(viz)

# med_freq

data <- data.frame(x1=med_freqLOL_Death_1yr$Xr[,1], x2=med_freqLOL_Death_1yr$Xr[,2],x3=med_freqLOL_Death_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Med Freq Mortality within 1 Year") +
  labs(color = "Death_yr")
ggplotly(viz)

# sma

data <- data.frame(x1=smaLOL_Death_1yr$Xr[,1], x2=smaLOL_Death_1yr$Xr[,2],x3=smaLOL_Death_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("SMA Mortality within 1 Year") +
  labs(color = "Death_yr")
ggplotly(viz)

# wavelets

data <- data.frame(x1=waveletsLOL_Death_1yr$Xr[,1], x2=waveletsLOL_Death_1yr$Xr[,2],x3=waveletsLOL_Death_1yr$Xr[,3],y=Y)
viz<-ggplot(data, aes(x=x1, y=x2, color=y)) +
  geom_point() +
  xlab("Projection 1") +
  ylab("Projection 2") +
  ggtitle("Wavelets Mortality within 1 Year") +
  labs(color = "Death_yr")
ggplotly(viz)
```