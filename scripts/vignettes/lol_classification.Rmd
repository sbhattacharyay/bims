---
title: "Classification of Functional Outcoes with Linear Optimal Low Rank Projection (LOL)"
author: "Shubhayu Bhattacharyay, Eshan Joshi, and Matthew Wang"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(devtools)
if (!require(lolR)) install_github('neurodata/lol', build_vignettes=TRUE, force=TRUE)
library(lolR)
library(R.matlab)
library(tidyverse)
library(ggplot2)
library(plotly)
library(naniar)
library(MASS)
library(caret)
library(cvAUC)
source("../functions/generateRootDir.R")
```

## Classification Scheme:
### Predictors:
* Age
* APACHE (for mortality prediction)
* GCS_en (for GOSE prediction)
* Motion Features (3 dimensions)

### Outcomes:
* 1: GOSE at Discharge
* 2: GOSE at 1 year
* 3: Mortality during hospital stay
* 4: Mortality within 1 year


```{r }
get_auc_info <- function(list_of_preds){
  
return (lapply(c(2:14), function(y) {
          lapply(seq_along(list_of_preds[[1]]), function(x) {
            cvAUC(list(list_of_preds[[1]][[x]][[y]],
                       list_of_preds[[2]][[x]][[y]],
                       list_of_preds[[3]][[x]][[y]],
                       list_of_preds[[4]][[x]][[y]],
                       list_of_preds[[5]][[x]][[y]]),
                  list(list_of_preds[[1]][[x]]$ground_truth,
                       list_of_preds[[2]][[x]]$ground_truth,
                       list_of_preds[[3]][[x]]$ground_truth,
                       list_of_preds[[4]][[x]]$ground_truth,
                       list_of_preds[[5]][[x]]$ground_truth))})
          }))
}

## [[1]]:bp_pred [[2]]:fe_pred [[3]]:fp_pred [[4]]:mf_pred [[5]]:sm_pred [[6]]:wv_pred
get_auc_plots <- function(plot_info, auc_info){
  filePath = paste0("../",generateRootDir(paste0(deparse(substitute(plot_info)),"/")))
  dir.create(filePath, recursive=TRUE,showWarnings = FALSE)
  color_choice = factor(auc_info[[1]][[1]])[2:14]
  names(color_choice) = gsub("_X1","",names(color_choice))
  val<-names(auc_info[[1]])
  lapply(c(1:6), function(y) {
    png(paste0(filePath,val[y],".png"))
      lapply(seq_along(plot_info), function(x) {
      plot(plot_info[[x]][[y]]$perf, col="grey", lty=3)
      plot(plot_info[[x]][[y]]$perf, avg="vertical",col=color_choice[x], lwd=2, add=TRUE) 
      par(new=TRUE) 
      })
    legend("bottomright", legend=names(color_choice),fill=color_choice,cex=0.75)  
    title(val[y])
    dev.off()
  })
}

```

```{r echo=FALSE}
self_GLM_dis<-get_auc_info(self_val_GLM_predictionsDis)
get_auc_plots(self_GLM_dis,self_val_GLM_predictionsDis)

test_GLM_dis<-get_auc_info(test_val_GLM_predictionsDis)
get_auc_plots(test_GLM_dis,test_val_GLM_predictionsDis)

self_SVM_dis<-get_auc_info(self_val_SVM_predictionsDis)
get_auc_plots(self_SVM_dis,self_val_SVM_predictionsDis)

test_SVM_dis<-get_auc_info(test_val_SVM_predictionsDis)
get_auc_plots(test_SVM_dis,test_val_SVM_predictionsDis)

self_LDA_dis<-get_auc_info(self_val_LDA_predictionsDis)
get_auc_plots(self_LDA_dis,self_val_LDA_predictionsDis)

test_LDA_dis<-get_auc_info(test_val_LDA_predictionsDis)
get_auc_plots(test_LDA_dis,test_val_LDA_predictionsDis)

self_kNN_dis<-get_auc_info(self_val_kNN_predictionsDis)
get_auc_plots(self_kNN_dis,self_val_kNN_predictionsDis)

test_kNN_dis<-get_auc_info(test_val_kNN_predictionsDis)
get_auc_plots(test_kNN_dis,test_val_kNN_predictionsDis)
```

```{r }
get_auc_mean_sd <- function(plot_info, auc_info){
  info_list<-list()
  lapply(c(1:6), function(y) {
      means <- c()
      stddevs <- c()
      lapply(seq_along(plot_info), function(x) {
      means<<-c(means,mean(plot_info[[x]][[y]]$fold.AUC))
      stddevs<<-c(stddevs,sd(plot_info[[x]][[y]]$fold.AUC))
      })
      info_list[[y]]<<-data.frame(mean=means,stddev=stddevs, row.names=names(auc_info[[1]][[1]])[2:7])
  })
  names(info_list)<-c(names(auc_info[[1]]))
  return (info_list)
}

self_dis_metrics<-get_auc_mean_sd(self_dis,self_val_predictionsDis)
self_12mo_metrics<-get_auc_mean_sd(self_12mo,self_val_predictions12mo)
test_dis_metrics<-get_auc_mean_sd(test_dis,test_val_predictionsDis)
test_12mo_metrics<-get_auc_mean_sd(test_12mo,test_val_predictions12mo)
```
   