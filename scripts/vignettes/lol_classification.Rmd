---
title: "Classification of Functional Outcoes with Linear Optimal Low Rank Projection (LOL)"
author: "Shubhayu Bhattacharyay, Eshan Joshi, and Matthew Wang"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(devtools)
if (!require(lolR)) install_github('neurodata/lol', build_vignettes=TRUE, force=TRUE)
library(lolR)
library(R.matlab)
library(tidyverse)
library(ggplot2)
library(plotly)
library(naniar)
library(MASS)
library(caret)
if(!exists("sensors")) {
  sensors<-readMat('../motion_feature_data/bed_corrected_imputed_complete_sensor_data.mat')$bed.corrected.sensors
}
na_strings <- c("NA", "N A", "N / A", "N/A", "N/ A", "Not Available", "NOt available","NaN")
if(!exists("patient_table")) {
  patient_table<-read.csv('../clinical_data/patient_table.csv',na.strings=c("NA","NaN", " ") )%>%replace_with_na_all(condition = ~.x %in% na_strings)%>%mutate(GOSE=factor(GOSE),GOSE_1yr=factor(GOSE_1yr),Death=factor(Death),Death_1yr=factor(Death_1yr))
}
studyPatients<-c(2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,58,59,60,61,62,63,64,66,67)
studyPatientsPY<-c(2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,49,51,46,47,48,50,52,53,54,55,56,57,59,60,61,62,63,64,65,67,68)

sortOrder<-sort(studyPatientsPY,index.return=TRUE)$ix
PYpatient_table<-patient_table[sortOrder,]
PY_1yr_patient_table<-PYpatient_table %>% drop_na(Death_1yr)

temp_var<-do.call(rbind,sensors)
#ranked_temp_var<-lapply(temp_var, function(x) t(apply(x,1,sort,decreasing = TRUE)))
#fft_temp_var<-lapply(temp_var, function(x) abs(t(mvfft(t(x)))))
band_powerFeats<-do.call(cbind,temp_var[1:6])
freq_entropyFeats<-do.call(cbind,temp_var[7:12])
freq_pairsFeats<-do.call(cbind,temp_var[13:24])
med_freqFeats<-do.call(cbind,temp_var[25:30])
smaFeats<-do.call(cbind,temp_var[31:36])
waveletsFeats<-do.call(cbind,temp_var[37:42])

write.csv(band_powerFeats, file = './yoopy.csv', row.names = FALSE,col.names = FALSE)
```

## Classification Scheme:
### Predictors:
* Age
* APACHE (for mortality prediction)
* GCS_en (for GOSE prediction)
* Motion Features (3 dimensions)

### Outcomes:
* 1: GOSE at Discharge
* 2: GOSE at 1 year
* 3: Mortality during hospital stay
* 4: Mortality within 1 year

```{r}
set.seed(123) 
Y<-PYpatient_table$GOSE
r<-5

yoyoyo<-lol.xval.eval(band_powerFeats, Y, r, alg = lol.project.lol, alg.return="A", classifier=MASS::lda, classifier.return="class", k=5)


yooki<- lol.xval.optimal_dimselect(cbind(PYpatient_table$Age,PYpatient_table$GCS_en), Y, rs=c(2), alg = lol.project.lol, alg.return="A",classifier=MASS::lda, classifier.return="class", k=5)


```


```{r}
data(ROCR.hiv)
attach(ROCR.hiv)

out <- cvAUC(hiv.svm$predictions, hiv.svm$labels)

#Plot fold AUCs
plot(out$perf, col="grey82", lty=3, main="5-fold CV AUC")

#Plot CV AUC
plot(out$perf, col="red", avg="vertical", add=TRUE)

plot(PYpatient_table$GCS_en, col="red", avg="vertical", add=TRUE)

pred<-prediction(PYpatient_table$GCS_en)

```